___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "CHEQ Enforce",
  "categories": [
    "TAG_MANAGEMENT"
  ],
  "brand": {
    "id": "cheq.ai",
    "displayName": "CHEQ",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Ensure privacy and compliance with CHEQ Enforceâ€”streamline data governance, secure user data, and manage consent effortlessly.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "account",
    "displayName": "Account",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "publish_path",
    "displayName": "Publish Path",
    "simpleValueType": true
  },
  {
    "type": "PARAM_TABLE",
    "name": "region_specific_consent",
    "displayName": "Region-Specific Default Consent Overrides",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "region",
          "displayName": "Region Code(s)",
          "simpleValueType": true,
          "valueHint": "US-CA,GB,SK",
          "textAsList": false,
          "help": "A comma-delimited list of region codes specifying which region the consent settings apply to. Region codes are expressed using country and/or subdivisions in ISO 3166-2 format.",
          "valueValidators": [
            {
              "type": "NON_EMPTY"
            }
          ]
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_personalization",
          "displayName": "ad_personalization",
          "selectItems": [
            {
              "value": "default",
              "displayValue": "Default"
            },
            {
              "value": "granted",
              "displayValue": "Granted"
            },
            {
              "value": "denied",
              "displayValue": "Denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_storage",
          "displayName": "ad_storage",
          "selectItems": [
            {
              "value": "default",
              "displayValue": "Default"
            },
            {
              "value": "granted",
              "displayValue": "Granted"
            },
            {
              "value": "denied",
              "displayValue": "Denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "ad_user_data",
          "displayName": "ad_user_data",
          "selectItems": [
            {
              "value": "default",
              "displayValue": "Default"
            },
            {
              "value": "granted",
              "displayValue": "Granted"
            },
            {
              "value": "denied",
              "displayValue": "Denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "analytics_storage",
          "displayName": "analytics_storage",
          "selectItems": [
            {
              "value": "default",
              "displayValue": "Default"
            },
            {
              "value": "granted",
              "displayValue": "Granted"
            },
            {
              "value": "denied",
              "displayValue": "Denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "functionality_storage",
          "displayName": "functionality_storage",
          "selectItems": [
            {
              "value": "default",
              "displayValue": "Default"
            },
            {
              "value": "granted",
              "displayValue": "Granted"
            },
            {
              "value": "denied",
              "displayValue": "Denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "personalization_storage",
          "displayName": "personalization_storage",
          "selectItems": [
            {
              "value": "default",
              "displayValue": "Default"
            },
            {
              "value": "granted",
              "displayValue": "Granted"
            },
            {
              "value": "denied",
              "displayValue": "Denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "default"
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "SELECT",
          "name": "security_storage",
          "displayName": "security_storage",
          "selectItems": [
            {
              "value": "default",
              "displayValue": "Default"
            },
            {
              "value": "granted",
              "displayValue": "Granted"
            },
            {
              "value": "denied",
              "displayValue": "Denied"
            }
          ],
          "simpleValueType": true,
          "defaultValue": "default"
        },
        "isUnique": false
      }
    ],
    "newRowButtonText": "Add region-specific default",
    "newRowTitle": "Add region-specific default",
    "help": "If you would like to have different default consent rules per region, you can enter those defaults here. Any region that is not defined will automatically take the global default set in the previous section."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const encodeUri = require('encodeUri');
const gtagSet = require('gtagSet');
const injectScript = require('injectScript');
const Object = require('Object');
const queryPermission = require('queryPermission');
const setDefaultConsentState = require('setDefaultConsentState');

if (!data.account) return data.gtmOnFailure();
if (!data.publish_path) return data.gtmOnFailure();

gtagSet('developer_id.dNjQwYj', true);
(data.region_specific_consent || []).forEach((region_consent) => {
  if (region_consent.region) {
    const parsed_region = region_consent.region.split(',').map(item => item.trim().toUpperCase());
    const consent_state = {};
    consent_state.region = parsed_region;
    
    Object.entries(region_consent).forEach((params) => {
      const key = params[0];
      const value = params[1];
      if ((key !== 'region') && (value !== 'default')) {
        consent_state[key] = value;
      }
    });

    setDefaultConsentState(consent_state);
  }
});

const script = 'https://nexus.ensighten.com/' + encodeUri(data.account) + '/' + encodeUri(data.publish_path) + '/Bootstrap.js';
if (queryPermission('inject_script', script)) {
  injectScript(script, data.gtmOnSuccess, data.gtmOnFailure);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://nexus.ensighten.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 3/6/2025, 3:23:22 PM
